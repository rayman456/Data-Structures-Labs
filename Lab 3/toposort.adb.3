with Ada.Integer_Text_IO;
use Ada.Integer_Text_IO;
with Ada.Text_IO; use Ada.Text_IO;
with Ada.Unchecked_Deallocation;
package body Toposort is

   type Node;
   type NodePt is access Node;
   type Node is
      record
         Info : ITEM;
         Next : NodePt;
      end record;

   procedure TopologicalSort is

      procedure Free is
      new Ada.Unchecked_Deallocation(Node, NodePt);

      NA : Integer;
      KN : Integer;

   begin
      --Step 2
      Put("Eneter total number of possible steps: ");
      Get(NA);
      Put("Enter total number of relations to be processed: ");
      Get(KN);
      declare
         QLink : array(ITEM) of ITEM := (others => ITEM'Val(0));
         Count : array(ITEM) of Integer := (others => 0);
         Top: array(ITEM) of NodePt := (others => null);
         J : ITEM;
         K : ITEM;
         F : ITEM;
         R : ITEM;
         P : NodePt;
         Dp : NodePt;
      begin
         for I in reverse 1..KN loop
            put("Item: ");
            Get(J);
            Put("Comes before Item: ");
            Get(K);
            Top(J) := new Node'(Info => K, Next => Top(J));
            Count(K) := Count(K) + 1;
            Put("You have ");
            Put(I-1, 2);
            Put_Line(" relations left.");
         end loop;
         KN := NA;
         R := ITEM'Val(0);
         QLink(ITEM'Val(0)) := ITEM'Val(0);
         for I in ITEM'Val(1)..ITEM'Val(NA) loop
            if Count(I) = 0 then
               QLink(R) := I;
               R := I;
            end if;
         end loop;
         F := QLink(ITEM'Val(0));
         while F /= ITEM'Val(0) loop
            Put("Perform action ");
            Put(F); new_line;
            KN := KN - 1;
            P := Top(F);
            Top(F) := null;
            while P /= null loop
               Count(P.Info) := Count(P.Info) - 1;
               if Count(P.Info) = 0 then
                  QLink(R) := P.Info;
                  R := P.Info;
               end if;
               P := P.Next;
            end loop;
            F := QLink(F);
         end loop;
         if KN = 0 then
            Put("Successful Sort!");
         else
            Put_Line("Error!");
         end if;
      end;
   end;
end Toposort;
